name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name for release (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: read
  issues: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Get Previous Tag
        id: previoustag
        run: |
          # Get the previous tag (before current one)
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "${{ steps.tag.outputs.tag }}" | head -n 1)
          if [ -z "$PREVIOUS_TAG" ]; then
            # If no previous tag, use the first commit
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "üìå Previous tag/commit: $PREVIOUS_TAG"

      - name: Build Structured Changelog
        id: structured_changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          configuration: |
            {
              "template": "#{{CHANGELOG}}",
              "categories": [
                {
                  "title": "## üéâ Features",
                  "labels": ["feature", "feat", "feature request", "enhancement"]
                },
                {
                  "title": "## üêõ Bug Fixes",
                  "labels": ["bug", "fix", "bugfix"]
                },
                {
                  "title": "## üìö Documentation",
                  "labels": ["documentation", "docs"]
                },
                {
                  "title": "## üîß Maintenance",
                  "labels": ["chore", "dependencies"]
                },
                {
                  "title": "## üöÄ Performance",
                  "labels": ["performance"]
                },
                {
                  "title": "## üîí Security",
                  "labels": ["security"]
                }
              ],
              "label_extractor": [
                {
                  "pattern": "^(feat|feature)(\\(.+\\))?:",
                  "target": "feature"
                },
                {
                  "pattern": "^fix(\\(.+\\))?:",
                  "target": "bug"
                },
                {
                  "pattern": "^docs?(\\(.+\\))?:",
                  "target": "documentation"
                },
                {
                  "pattern": "^chore(\\(.+\\))?:",
                  "target": "chore"
                },
                {
                  "pattern": "^perf(\\(.+\\))?:",
                  "target": "performance"
                }
              ]
            }
          fromTag: ${{ steps.previoustag.outputs.tag }}
          toTag: ${{ steps.tag.outputs.tag }}
          failOnError: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate AI-Enhanced Changelog
        id: ai_changelog
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          STRUCTURED_CHANGELOG: ${{ steps.structured_changelog.outputs.changelog }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TAG: ${{ steps.tag.outputs.tag }}
          PREV_TAG: ${{ steps.previoustag.outputs.tag }}
          REPO: ${{ github.repository }}
        with:
          script: |
            const structuredChangelog = process.env.STRUCTURED_CHANGELOG;
            const apiKey = process.env.OPENAI_API_KEY;
            const tag = process.env.TAG;
            const prevTag = process.env.PREV_TAG;
            const repo = process.env.REPO;
            
            if (!apiKey) {
              console.log('‚ö†Ô∏è  No OPENAI_API_KEY found - skipping AI enhancement');
              core.setOutput('enhanced', '');
              return;
            }
            
            // Get commit details between tags
            const { data: commits } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: prevTag,
              head: tag
            });
            
            // Extract commit messages and files changed
            const commitSummary = commits.commits.map(c => ({
              message: c.commit.message,
              author: c.commit.author.name,
              files: c.files?.length || 0
            }));
            
            const filesChanged = commits.files?.map(f => f.filename) || [];
            const stats = {
              commits: commits.commits.length,
              files: filesChanged.length,
              additions: commits.commits.reduce((sum, c) => sum + (c.stats?.additions || 0), 0),
              deletions: commits.commits.reduce((sum, c) => sum + (c.stats?.deletions || 0), 0)
            };
            
            console.log('üìä Changes:', JSON.stringify(stats, null, 2));
            
            try {
              const systemPrompt = [
                'You are a technical writer creating release notes for pgctl, a PostgreSQL CLI management tool written in Bash.',
                '',
                'Your task:',
                '1. Analyze the changes between releases',
                '2. Create professional, user-friendly release notes',
                '3. Highlight key improvements and their impact on users',
                '4. Keep technical accuracy while being accessible',
                '5. Use emojis appropriately for visual organization',
                '6. Group related changes together logically',
                '',
                'Format:',
                '- Start with a brief 2-3 sentence overview',
                '- Organize changes by category with clear headings',
                '- Use bullet points for clarity',
                '- Mention statistics (commits, files, lines) if significant',
                '- Keep it concise but informative'
              ].join('\n');
              
              const userPrompt = [
                `Create release notes for ${tag} (previous: ${prevTag})`,
                '',
                '**Statistics:**',
                `- ${stats.commits} commits`,
                `- ${stats.files} files changed`,
                `- +${stats.additions} / -${stats.deletions} lines`,
                '',
                '**Structured Changelog:**',
                structuredChangelog,
                '',
                '**Recent Commits:**',
                commitSummary.slice(0, 10).map(c => `- ${c.message.split('\n')[0]}`).join('\n'),
                '',
                '**Key Files Modified:**',
                filesChanged.slice(0, 15).join(', '),
                '',
                'Create comprehensive release notes with an overview, categorized changes, and highlight the most important improvements for users.'
              ].join('\n');
              
              const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                  model: 'gpt-4o',
                  messages: [
                    {
                      role: 'system',
                      content: systemPrompt
                    },
                    {
                      role: 'user',
                      content: userPrompt
                    }
                  ],
                  temperature: 0.7,
                  max_tokens: 2500
                })
              });
              
              if (!response.ok) {
                const error = await response.text();
                throw new Error(`OpenAI API error: ${response.status} - ${error}`);
              }
              
              const data = await response.json();
              const content = data.choices?.[0]?.message?.content || '';
              
              if (content) {
                console.log('‚úÖ AI-enhanced changelog generated successfully');
                core.setOutput('enhanced', content);
              } else {
                console.log('‚ö†Ô∏è  No content returned from AI');
                core.setOutput('enhanced', '');
              }
            } catch (error) {
              console.error('‚ùå AI enhancement failed:', error.message);
              core.setOutput('enhanced', '');
            }

      - name: Prepare Final Release Notes
        id: release_notes
        uses: actions/github-script@v7
        env:
          AI_ENHANCED: ${{ steps.ai_changelog.outputs.enhanced }}
          STRUCTURED: ${{ steps.structured_changelog.outputs.changelog }}
          TAG: ${{ steps.tag.outputs.tag }}
          PREV_TAG: ${{ steps.previoustag.outputs.tag }}
          REPO: ${{ github.repository }}
        with:
          script: |
            const aiEnhanced = process.env.AI_ENHANCED;
            const structured = process.env.STRUCTURED;
            const tag = process.env.TAG;
            const prevTag = process.env.PREV_TAG;
            const repo = process.env.REPO;
            
            let body = '';
            
            if (aiEnhanced && aiEnhanced.trim()) {
              console.log('‚úÖ Using AI-enhanced changelog');
              body = aiEnhanced;
            } else {
              console.log('üìù Using structured changelog (AI unavailable)');
              body = `## üìù What's Changed\n\n${structured}`;
            }
            
            // Add comparison link
            body += `\n\n**Full Changelog**: https://github.com/${repo}/compare/${prevTag}...${tag}`;
            
            // Add installation section
            body += `\n\n## üöÄ Installation\n\n`;
            body += '```bash\n';
            body += `git clone https://github.com/${repo}.git\n`;
            body += `cd ${repo.split('/')[1]}\n`;
            body += './install.sh\n';
            body += '```\n';
            
            // Add documentation links
            body += '\n## üìñ Documentation\n\n';
            body += `- [README](https://github.com/${repo}/blob/main/README.md)\n`;
            body += `- [Installation Guide](https://github.com/${repo}/blob/main/docs/INSTALLATION.md)\n`;
            body += `- [Contributing](https://github.com/${repo}/blob/main/docs/CONTRIBUTING.md)\n`;
            
            core.setOutput('body', body);
            return body;

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: ${{ steps.release_notes.outputs.body }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        uses: EndBug/latest-tag@latest
        with:
          ref: latest
          description: Latest stable release
          force-branch: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
